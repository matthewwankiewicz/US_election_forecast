#### Preamble ####
# Purpose: Prepare and clean the survey data downloaded from Voter Study Group
# Author: Alen Mitrovski, Xiaoyan Yang and Matthew Wankiewicz
# Data: 22 October 2020
# Contact: matthew.wankiewicz@mail.utoronto.ca
# License: MIT
# Pre-requisites: 
# - Need to have downloaded the data from Voter Group Webste after requesting access
# and save the folder that you're interested in to inputs/data
# - Don't forget to gitignore it!


#### Workspace setup ####
library(haven)
library(tidyverse)
# Read in the raw data (You might need to change this if you use a different dataset)
raw_data <- read_dta("inputs/data/ns20200625/ns20200625.dta")
# Add the labels
raw_data <- labelled::to_factor(raw_data)
# Just keep some variables
reduced_data <- 
  raw_data %>% 
  select(interest,
         registration,
         vote_2016,
         vote_intention,
         vote_2020,
         ideo5,
         employment,
         foreign_born,
         gender,
         census_region,
         hispanic,
         race_ethnicity,
         household_income,
         education,
         state,
         congress_district,
         age)


#### What else???? ####
# Maybe make some age-groups?
# Maybe check the values?
# Is vote a binary? If not, what are you going to do?

names_matcher <- tibble(stateicp = state.name, state = state.abb)

# group voter ages by intervals of 10 years or so
# filter out people that are undecided or who will vote someone else, then create a variable called
# vote_biden gives a 1 if they vote for Biden, 0 for Trump

reduced_data_new <- reduced_data %>% filter(vote_2020 == "Joe Biden" | vote_2020 == "Donald Trump") %>% 
  mutate(age_groups = case_when(
    age <= 35 ~ "18-35",
    age <= 50 ~ "36-49",
    age <= 65 ~ "50-65",
    age >= 65 ~ "65+"
  ),
  vote_biden = ifelse(vote_2020 == "Joe Biden", 1, 0),
  sex = ifelse(gender == "Female", "female", "male"),
  races = case_when(
    race_ethnicity == "White" ~ "white",
    race_ethnicity == "Black, or African American" ~ "black",
    race_ethnicity == "American Indian or Alaska Native" ~ "other race, nec",
    race_ethnicity == "Asian (Chinese)" ~ "asian",
    race_ethnicity == "Asian (Japanese)" ~ "asian",
    race_ethnicity == "Asian (Asian Indian)" ~ "asian",
    race_ethnicity == "Asian (Filipino)" ~ "asian",
    race_ethnicity == "Asian (Korean)" ~ "asian",
    race_ethnicity == "Asian (Vietnamese)" ~ "asian",
    race_ethnicity == "Asian (Other)" ~ "asian",
    race_ethnicity == "Pacific Islander (Native Hawaiian)" ~ "asian",
    race_ethnicity == "Pacific Islander (Guamanian)" ~ "asian",
    race_ethnicity == "Pacific Islander (Samoan)" ~ "asian",
    race_ethnicity == "Pacific Islander (Other)" ~ "asian",
    race_ethnicity == "Some other race" ~ "other race, nec"
  ),
  hispan = ifelse(hispanic == "Not Hispanic", "not hispanic",
                  ifelse(hispanic == "Mexican", "mexican", 
                         ifelse(hispanic == "Puerto Rican", "puerto rican",
                                ifelse(hispanic == "Cuban", "cuban", "other")))),
  empstat = case_when(
    employment == "Full-time employed" ~ "employed",
    employment == "Part-time employed" ~ "employed",
    employment == "Self-employed" ~ "employed",
    employment == "Homemaker" ~ "not in labor force",
    employment == "Retired" ~ "not in labor force",
    employment == "Student" ~ "not in labor force",
    employment == "Permanently disabled" ~ "not in labor force",
    employment == "Other:" ~ "not in labor force",
    employment == "Unemployed or temorarily on layoff" ~ "unemployed"
  ),
  education_level = case_when(
    education == "3rd Grade or less" ~ "High school or lower",
    education == "Middle School - Grades 4 - 8" ~ "High school or lower",
    education == "Completed some high school" ~ "High school or lower",
    education == "High school graduate" ~ "High school or lower",
    education == "Other post high school vocational training" ~ "High school or lower",
    education == "Completed some college, but no degree" ~ "Completed some college, but no degree",
    education == "Associate Degree" ~ "Post Secondary or Higher",
    education == "College Degree (such as B.A., B.S.)" ~ "Post Secondary or Higher",
    education == "Completed some graduate, but no degree" ~ "Post Secondary or Higher",
    education == "Masters degree" ~ "Post Secondary or Higher",
    education == "Doctorate degree" ~ "Post Secondary or Higher",
  )
  )

# format state names so the whole state name is written out, to match IPUMS data

reduced_data_new <-
  reduced_data_new %>%
  left_join(names_matcher)

# make lowercase to match IPUMS data

reduced_data_new <- reduced_data_new %>% 
  mutate(stateicp = tolower(stateicp))

# replace NA's with DC, makes sense to replace because it may not have been listed in survey
reduced_data_new$stateicp <- replace_na(reduced_data_new$stateicp, "district of columbia")

# change format of columns to match post-strat formats

reduced_data_new$sex <- as.factor(reduced_data_new$sex)
reduced_data_new$races <- as.factor(reduced_data_new$races)
reduced_data_new$stateicp <- as.factor(reduced_data_new$stateicp)
reduced_data_new$hispan <- as.factor(reduced_data_new$hispan)
reduced_data_new$education_level <- as.factor(reduced_data_new$education_level)


write_rds(reduced_data_new, "outputs/paper/polling_data.rds")
