---
title: "forecasting_election2020"
author: "Alen Mitrovski, Xiaoyan Yang, Matthew Wankiewicz"
date: "November 2nd, 2020"
abstract: |
  | First sentence. Second sentence. Third sentence. Fourth sentence.
  |
  | **Keywords:** Forecasting, US 2020 Election, Trump, Biden;
output:
  bookdown::pdf_document2:
    citation_package: natbib
toc: FALSE
bibliography: references.bib
---

```{r, echo=F, message=F, warning=F}
#install.packages("tidyverse")
#install.packages("gtsummary")
#install.packages("statebins")
library(tidyverse)
library(statebins)
```

```{r, echo=F, message=F, warning=F}
# read in the polling data
polling <- readRDS("polling_data.rds")

# rename columns of polling data to match post-strat
polling <- polling %>% 
  rename(income_group = household_income,
         education_level = education)

# read in post-strat data 
post_strat <- readRDS("post_strat.rds")
post_strat <- post_strat %>% 
  filter(race != "two major races", race != "three or more major races",
         age >= 18)
```

# Introduction

# Data

## Polling

We have used @citeR and @citeTidyverse for data analysis

Data is from @citeIPUMS and from @citeVSG

```{r data1, echo=F, message=F, warning=F, fig.cap="Demographics of Sample and Population"}

# set up proportions and plots for polling data (variables we focus on)
gender <- polling %>% 
  group_by(sex) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "gender") %>% 
  rename(level = sex)

race <- polling %>% 
  group_by(race) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "race") %>% 
  rename(level = race)

income <- polling %>% 
  group_by(income_group) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "income") %>% 
  drop_na(income_group) %>% 
  rename(level = income_group)

age <- polling %>% 
  group_by(age_groups) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "age") %>% 
  rename(level = age_groups)

 statesicp <- polling %>% 
  group_by(stateicp) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "state") %>% 
   rename(level = stateicp)

 education <- polling %>% 
  group_by(education_level) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "poll",
         group = "education") %>% 
   rename(level = education_level)

# set up proportions for post-strat data

gender_post <- post_strat %>% 
  group_by(sex) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "gender") %>% 
  rename(level = sex)

race_post <- post_strat %>% 
  group_by(race) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "race") %>% 
  rename(level = race)

income_post <- post_strat %>% 
  group_by(income_group) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "income") %>% 
  rename(level = income_group)

age_post <- post_strat %>% 
  group_by(age_groups) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "age") %>% 
  rename(level = age_groups)

statesicp_post <- post_strat %>% 
  group_by(stateicp) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "state") %>% 
  rename(level = stateicp)

education_post <- post_strat %>% 
  group_by(education_level) %>% 
  summarise(n = n()) %>% 
  mutate(pct = n/sum(n), type = "post_strat",
         group = "education") %>% 
  rename(level = education_level)

variables <- rbind(education, education_post,
             age, age_post, gender, gender_post, 
             race, race_post)

variables %>% ggplot(aes(as.factor(level), pct, group=as.factor(type), linetype = as.factor(type))) + 
  geom_line() + facet_grid(~group, scales = "free") + 
  theme(axis.text.x = element_text(angle=70, size = 6, hjust = 1)) +
  labs(x = "category", y = "percentage", linetype = "data set") + 
  scale_y_continuous(labels = scales::percent)
```

```{r data2, echo = F, message=F, warning=F, fig.cap="More Demographics of Sample and Population"}
variables2 <- rbind(income, income_post,
                    statesicp, statesicp_post)
variables2 %>% ggplot(aes(as.factor(level), pct, group=as.factor(type), linetype = as.factor(type))) + 
  geom_line() + facet_wrap(~group, nrow = 2, scales = "free") + 
  theme(axis.text.x = element_text(angle=70, size = 6, hjust = 1)) +
  labs(x = "category", y = "percentage", linetype = "data set") +
  scale_y_continuous(labels = scales::percent)
```


# Model

```{r model, echo = F, message=F, warning=F, fig.cap="Results of Regression Model"}
model <- glm(vote_biden ~ sex + age_groups + race +
               stateicp + income_group + education_level, 
             data = polling, family = binomial())

gtsummary::tbl_regression(model)
```

This table was created using the results from our model and the tbl_regression function from @citeGT

```{r prediction, echo=F, warning=F, message=F}
post_strat$prediction <- predict(model, 
                                 newdata = post_strat, 
                                 type="response")

post_strat <- post_strat %>% 
  mutate(vote_biden = ifelse(prediction < .5, 0, 1))
```


# Results

```{r stateplot, echo=F, message=F, warning=F, fig.cap="Proportion of each State Voting for Biden"}
state_props <- post_strat %>% 
  group_by(stateicp, vote_biden) %>% 
  summarise(n = n()) %>% 
  mutate(Freq = n/sum(n))

state_props$stateicp <- as.character(state_props$stateicp)

state_props %>% 
  mutate(statename = str_to_title(stateicp)) %>% 
  ggplot(aes(fill = Freq, state = statename)) + 
  geom_statebins() + 
  scale_fill_gradient2(low = "red", mid = "grey", high = "blue", midpoint = 0.5) +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "Proportion Voting \n for Biden")
```

This plot was created using @citeStatebins


# Discussion

# References


